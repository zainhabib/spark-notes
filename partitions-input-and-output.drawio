<mxfile host="app.diagrams.net" agent="Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:136.0) Gecko/20100101 Firefox/136.0" version="26.1.0">
  <diagram name="Page-1" id="AEn0jylJaO9_Q2qLZWY8">
    <mxGraphModel dx="848" dy="1151" grid="1" gridSize="10" guides="1" tooltips="1" connect="1" arrows="1" fold="1" page="1" pageScale="1" pageWidth="850" pageHeight="1400" math="0" shadow="0">
      <root>
        <mxCell id="0" />
        <mxCell id="1" parent="0" />
        <mxCell id="JH_YOpZ5jYF-nCQf6kfj-1" value="&lt;div align=&quot;left&quot;&gt;&lt;font style=&quot;font-size: 20px;&quot;&gt;&lt;b&gt;&lt;font&gt;Input Partitions - Right Sizing&lt;/font&gt;&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;" style="text;html=1;align=left;verticalAlign=middle;whiteSpace=wrap;rounded=0;" vertex="1" parent="1">
          <mxGeometry x="40" y="10" width="630" height="30" as="geometry" />
        </mxCell>
        <mxCell id="JH_YOpZ5jYF-nCQf6kfj-2" value="&lt;div&gt;&lt;font style=&quot;font-size: 14px;&quot;&gt;Use Spark Defaults -- 128MB -- unless ...&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;ul&gt;&lt;li&gt;&lt;font style=&quot;font-size: 14px;&quot;&gt;Increase Parallelism (scale down the size of &lt;b&gt;maxPartitionBytes&lt;/b&gt;)&lt;/font&gt;&lt;/li&gt;&lt;li&gt;&lt;font style=&quot;font-size: 14px;&quot;&gt;Heavily Nested / Repetitive Data (Arrays of Structs of Arrays)&lt;/font&gt;&lt;/li&gt;&lt;li&gt;&lt;font style=&quot;font-size: 14px;&quot;&gt;Generating Data - i.e. Explode&lt;/font&gt;&lt;/li&gt;&lt;li&gt;&lt;font style=&quot;font-size: 14px;&quot;&gt;Source of Structure is not optimal (upstream)&lt;/font&gt;&lt;/li&gt;&lt;li&gt;&lt;font style=&quot;font-size: 14px;&quot;&gt;UDFs&lt;/font&gt;&lt;/li&gt;&lt;/ul&gt;&lt;div&gt;&lt;font style=&quot;font-size: 14px;&quot;&gt;&lt;br&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font style=&quot;font-size: 14px;&quot; face=&quot;Courier New&quot;&gt;&lt;b&gt;&lt;span style=&quot;color: rgb(0, 76, 153);&quot;&gt;spark.conf.set&lt;/span&gt;&lt;/b&gt;(&quot;&lt;span style=&quot;color: rgb(0, 153, 0);&quot;&gt;spark.sql.files.&lt;b&gt;maxPartitionBytes&lt;/b&gt;&lt;/span&gt;&quot;, &lt;span style=&quot;color: rgb(255, 51, 51);&quot;&gt;16777216&lt;/span&gt;)&lt;/font&gt;&lt;/div&gt;&lt;/div&gt;" style="text;html=1;align=left;verticalAlign=middle;whiteSpace=wrap;rounded=0;" vertex="1" parent="1">
          <mxGeometry x="40" y="80" width="650" height="210" as="geometry" />
        </mxCell>
        <mxCell id="JH_YOpZ5jYF-nCQf6kfj-3" value="&lt;div align=&quot;left&quot;&gt;&lt;font style=&quot;font-size: 20px;&quot;&gt;&lt;b&gt;&lt;font&gt;Output Partitions - Right Sizing&lt;/font&gt;&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;" style="text;html=1;align=left;verticalAlign=middle;whiteSpace=wrap;rounded=0;" vertex="1" parent="1">
          <mxGeometry x="40" y="310" width="630" height="30" as="geometry" />
        </mxCell>
        <mxCell id="JH_YOpZ5jYF-nCQf6kfj-5" value="&lt;ul&gt;&lt;li&gt;&lt;font style=&quot;font-size: 14px;&quot;&gt;Write Once -&amp;gt; Read Many&lt;/font&gt;&lt;/li&gt;&lt;ul&gt;&lt;li&gt;&lt;font style=&quot;font-size: 14px;&quot;&gt;More time to Write but Faster to Read&lt;/font&gt;&lt;/li&gt;&lt;/ul&gt;&lt;li&gt;&lt;font style=&quot;font-size: 14px;&quot;&gt;Perfect writes limit parallelism&lt;/font&gt;&lt;/li&gt;&lt;ul&gt;&lt;li&gt;&lt;font style=&quot;font-size: 14px;&quot;&gt;Compaction (minor &amp;amp; major)&lt;/font&gt;&lt;/li&gt;&lt;/ul&gt;&lt;/ul&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;&lt;font style=&quot;font-size: 14px;&quot;&gt;Example:&lt;/font&gt;&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&lt;font&gt;Write Data Size = 14.7GB&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font&gt;Desired File Size = 1500MB&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font&gt;Max write stage parallelism = 10&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font&gt;96 - 10 = 86 cores idle during write&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font style=&quot;font-size: 14px;&quot;&gt;&lt;br&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font style=&quot;font-size: 14px;&quot;&gt;*** Using more cores will speed up the write process but will create &lt;b&gt;many small files &lt;/b&gt;... run auto optimize or run optimize offline to fix ***&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font style=&quot;font-size: 14px;&quot;&gt;&lt;br&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;&lt;font style=&quot;font-size: 14px;&quot;&gt;&lt;br&gt;&lt;/font&gt;&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;&lt;font style=&quot;font-size: 14px;&quot;&gt;Output Partitions -- Composition&lt;/font&gt;&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&lt;ul&gt;&lt;li&gt;&lt;font face=&quot;Courier New&quot; style=&quot;font-size: 14px;&quot;&gt;&lt;span style=&quot;color: rgb(0, 76, 153);&quot;&gt;df.write.option&lt;/span&gt;(&quot;maxRecordsPerFile&quot;, n)&lt;/font&gt;&lt;/li&gt;&lt;li&gt;&lt;font face=&quot;Courier New&quot; style=&quot;font-size: 14px;&quot;&gt;&lt;span style=&quot;color: rgb(0, 76, 153);&quot;&gt;df.coalesce&lt;/span&gt;(n).write ...&lt;/font&gt;&lt;/li&gt;&lt;li&gt;&lt;font face=&quot;Courier New&quot; style=&quot;font-size: 14px;&quot;&gt;&lt;span style=&quot;color: rgb(0, 76, 153);&quot;&gt;df.repartition&lt;/span&gt;(n).write ... &lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;span style=&quot;color: rgb(255, 51, 51);&quot;&gt;# avoid as usually requires another stage&lt;/span&gt;&lt;/font&gt;&lt;/li&gt;&lt;li&gt;&lt;font face=&quot;Courier New&quot; style=&quot;font-size: 14px;&quot;&gt;&lt;span style=&quot;color: rgb(0, 76, 153);&quot;&gt;df.repartition&lt;/span&gt;(n, [colA, ...]).write...&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;/font&gt;&lt;font face=&quot;Courier New&quot; style=&quot;font-size: 14px;&quot;&gt;&lt;span style=&quot;color: rgb(255, 51, 51);&quot;&gt;# avoid as usually requires another stage&lt;/span&gt;&lt;/font&gt;&lt;/li&gt;&lt;li&gt;&lt;font face=&quot;Courier New&quot; style=&quot;font-size: 14px;&quot;&gt;&lt;span style=&quot;color: rgb(0, 76, 153);&quot;&gt;spark.sql.shuffle.partitions&lt;/span&gt;(n)&lt;/font&gt;&lt;/li&gt;&lt;li&gt;&lt;font face=&quot;Courier New&quot; style=&quot;font-size: 14px;&quot;&gt;&lt;span style=&quot;color: rgb(0, 76, 153);&quot;&gt;df.localCheckpoint&lt;/span&gt;(...).repartition(n).write...&lt;/font&gt;&lt;/li&gt;&lt;li&gt;&lt;font face=&quot;Courier New&quot; style=&quot;font-size: 14px;&quot;&gt;&lt;span style=&quot;color: rgb(0, 76, 153);&quot;&gt;df.localCheckpoint&lt;/span&gt;(...).coalesce(n).write...&lt;/font&gt;&lt;/li&gt;&lt;/ul&gt;&lt;/div&gt;" style="text;html=1;align=left;verticalAlign=middle;whiteSpace=wrap;rounded=0;" vertex="1" parent="1">
          <mxGeometry x="40" y="370" width="760" height="410" as="geometry" />
        </mxCell>
        <mxCell id="JH_YOpZ5jYF-nCQf6kfj-6" value="&lt;div&gt;&lt;b style=&quot;color: rgb(0, 204, 0);&quot;&gt;&lt;font style=&quot;font-size: 16px;&quot;&gt;Maximize Parallelism&lt;/font&gt;&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&lt;font style=&quot;font-size: 14px;&quot;&gt;Utilize All Cores&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font style=&quot;font-size: 14px;&quot;&gt;Provision only the cores you need&lt;/font&gt;&lt;/div&gt;" style="text;html=1;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;strokeColor=default;strokeWidth=2;" vertex="1" parent="1">
          <mxGeometry x="295" y="830" width="250" height="100" as="geometry" />
        </mxCell>
      </root>
    </mxGraphModel>
  </diagram>
</mxfile>
